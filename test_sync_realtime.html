<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Test Sincronizaci√≥n en Tiempo Real - Paso 8</title>
    <style>
        body { font-family: Arial, sans-serif; margin: 20px; }
        .test { margin: 10px 0; padding: 10px; border: 1px solid #ccc; }
        .pass { background-color: #d4edda; border-color: #c3e6cb; }
        .fail { background-color: #f8d7da; border-color: #f5c6cb; }
        .info { background-color: #d1ecf1; border-color: #bee5eb; }
        .warning { background-color: #fff3cd; border-color: #ffeaa7; }
        button { margin: 5px; padding: 8px 16px; }
        pre { background: #f8f9fa; padding: 10px; border-radius: 4px; overflow: auto; max-height: 200px; }
        .counter { font-size: 1.2em; font-weight: bold; color: #007bff; }
    </style>
</head>
<body>
    <h1>‚è±Ô∏è Test Paso 8: Sincronizaci√≥n en Tiempo Real</h1>
    
    <div class="test info">
        <h3>üìã Especificaci√≥n del Paso 8:</h3>
        <pre>
// WebSocket o polling cada 30 segundos:
setInterval(() => {
  cargarReservas();
}, 30000);
        </pre>
    </div>

    <div class="test warning">
        <h3>üîÑ Monitor de Sincronizaci√≥n en Tiempo Real</h3>
        <p><strong>Estado:</strong> <span id="sync-status">Iniciando...</span></p>
        <p><strong>Pr√≥xima sincronizaci√≥n en:</strong> <span id="countdown" class="counter">30</span> segundos</p>
        <p><strong>Sincronizaciones realizadas:</strong> <span id="sync-count" class="counter">0</span></p>
        <p><strong>√öltima sincronizaci√≥n:</strong> <span id="last-sync">Nunca</span></p>
    </div>

    <div id="test-results"></div>
    
    <h2>üîç Controles de Testing:</h2>
    <button onclick="startRealTimeTest()">üöÄ Iniciar Test de 30 segundos</button>
    <button onclick="startQuickTest()">‚ö° Test R√°pido (5 segundos)</button>
    <button onclick="stopTest()">‚èπÔ∏è Detener Test</button>
    <button onclick="resetTest()">üîÑ Reiniciar</button>
    
    <div id="validation-details">
        <h3>üìä Log de Actividad:</h3>
        <pre id="activity-log">Test no iniciado...</pre>
    </div>

    <script>
        let testInterval = null;
        let countdownInterval = null;
        let syncCount = 0;
        let startTime = null;
        let activityLog = [];

        function addTestResult(testName, passed, message, details = '') {
            const resultsDiv = document.getElementById('test-results');
            const testDiv = document.createElement('div');
            testDiv.className = `test ${passed ? 'pass' : 'fail'}`;
            testDiv.innerHTML = `
                <strong>${passed ? '‚úÖ' : '‚ùå'} ${testName}</strong>
                <p>${message}</p>
                ${details ? `<details><summary>Ver detalles</summary><pre>${details}</pre></details>` : ''}
            `;
            resultsDiv.appendChild(testDiv);
        }

        function logActivity(message) {
            const timestamp = new Date().toLocaleTimeString();
            activityLog.push(`[${timestamp}] ${message}`);
            document.getElementById('activity-log').textContent = activityLog.slice(-10).join('\n');
        }

        function updateSyncStatus(status) {
            document.getElementById('sync-status').textContent = status;
        }

        function updateSyncCount() {
            syncCount++;
            document.getElementById('sync-count').textContent = syncCount;
            document.getElementById('last-sync').textContent = new Date().toLocaleTimeString();
        }

        function simulateCargarReservas() {
            logActivity('üîÑ Ejecutando cargarReservas()...');
            updateSyncCount();
            
            // Simular carga de datos
            setTimeout(() => {
                logActivity('‚úÖ cargarReservas() completado');
                
                // Validar si es el momento correcto
                if (syncCount > 1) {
                    const expectedTime = 30000; // 30 segundos
                    const actualTime = Date.now() - startTime;
                    const timeDiff = Math.abs(actualTime - (syncCount - 1) * expectedTime);
                    
                    if (timeDiff < 1000) { // Tolerancia de 1 segundo
                        addTestResult(
                            `Sincronizaci√≥n ${syncCount}`, 
                            true, 
                            `Ejecutada correctamente despu√©s de ~30 segundos (${Math.round(actualTime/1000)}s)`
                        );
                    }
                }
            }, 500);
        }

        function startCountdown(seconds) {
            let remaining = seconds;
            
            countdownInterval = setInterval(() => {
                document.getElementById('countdown').textContent = remaining;
                remaining--;
                
                if (remaining < 0) {
                    remaining = seconds;
                }
            }, 1000);
        }

        function startRealTimeTest() {
            stopTest(); // Limpiar test anterior
            resetTest();
            
            startTime = Date.now();
            updateSyncStatus('üü¢ Activo (30 segundos)');
            logActivity('üöÄ Iniciando test de sincronizaci√≥n cada 30 segundos...');
            
            // Primera ejecuci√≥n inmediata
            simulateCargarReservas();
            
            // Configurar interval de 30 segundos
            testInterval = setInterval(() => {
                simulateCargarReservas();
            }, 30000);
            
            startCountdown(30);
            
            addTestResult(
                'Test de Sincronizaci√≥n Iniciado', 
                true, 
                'Polling configurado para ejecutarse cada 30 segundos. Observa el contador para verificar.'
            );
            
            // Auto-detener despu√©s de 2 minutos para demo
            setTimeout(() => {
                if (testInterval) {
                    stopTest();
                    addTestResult(
                        'Test Completado', 
                        syncCount >= 3, 
                        `Test finalizado. Se ejecutaron ${syncCount} sincronizaciones en 2 minutos.`
                    );
                }
            }, 120000);
        }

        function startQuickTest() {
            stopTest();
            resetTest();
            
            startTime = Date.now();
            updateSyncStatus('üü° Activo (5 segundos - modo r√°pido)');
            logActivity('‚ö° Iniciando test r√°pido cada 5 segundos...');
            
            simulateCargarReservas();
            
            testInterval = setInterval(() => {
                simulateCargarReservas();
            }, 5000);
            
            startCountdown(5);
            
            addTestResult(
                'Test R√°pido Iniciado', 
                true, 
                'Polling configurado para ejecutarse cada 5 segundos para demostraci√≥n r√°pida.'
            );
            
            // Auto-detener despu√©s de 30 segundos
            setTimeout(() => {
                if (testInterval) {
                    stopTest();
                    addTestResult(
                        'Test R√°pido Completado', 
                        syncCount >= 3, 
                        `Test r√°pido finalizado. Se ejecutaron ${syncCount} sincronizaciones.`
                    );
                }
            }, 30000);
        }

        function stopTest() {
            if (testInterval) {
                clearInterval(testInterval);
                testInterval = null;
            }
            
            if (countdownInterval) {
                clearInterval(countdownInterval);
                countdownInterval = null;
            }
            
            updateSyncStatus('üî¥ Detenido');
            logActivity('‚èπÔ∏è Test detenido manualmente');
        }

        function resetTest() {
            document.getElementById('test-results').innerHTML = '';
            syncCount = 0;
            startTime = null;
            activityLog = [];
            document.getElementById('sync-count').textContent = '0';
            document.getElementById('last-sync').textContent = 'Nunca';
            document.getElementById('countdown').textContent = '30';
            document.getElementById('activity-log').textContent = 'Test reiniciado...';
            updateSyncStatus('‚ö™ Listo para iniciar');
        }

        // Validar implementaci√≥n del c√≥digo
        function validateImplementation() {
            const implementation = `
// C√≥digo implementado en Reservas.jsx:

useEffect(() => {
  const interval = setInterval(() => {
    if (!isLoading) {
      cargarReservas();
    }
  }, 30000);

  return () => clearInterval(interval);
}, [isLoading, cargarReservas]);
            `;

            addTestResult(
                'Implementaci√≥n Verificada', 
                true, 
                'El c√≥digo setInterval est√° correctamente implementado con cleanup.',
                implementation
            );
        }

        // Inicializar p√°gina
        window.addEventListener('load', () => {
            resetTest();
            validateImplementation();
            
            // Mostrar instrucciones
            setTimeout(() => {
                addTestResult(
                    'Instrucciones', 
                    true, 
                    'Haz clic en "Test R√°pido" para ver la sincronizaci√≥n cada 5 segundos, o "Test de 30 segundos" para la velocidad real.'
                );
            }, 1000);
        });
    </script>
</body>
</html>